<!DOCTYPE HTML>
<html>
	<head>
		<title>Terraform Tips</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="../assets/css/main.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
		<!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
	</head>
	<body>

    <!-- Header -->
        <header id="header">
            <h1><a href="../index.html">Think!</a></h1>
            <a href="../index.html">Back</a>
        </header>

        <!-- Blog -->
        <section id="main" class="wrapper">
            <div class="container">
                <header class="major special">
                    <h2>Terraform - Tips and Tricks while using with AWS</h2>
                </header>
                <div>
                    <span class="image left"><img src="../images/terraform.png" alt="" /></span>
                    <p>Having worked quite extentsively with AWS Cloudformation, I was quite apprehensive about using terraform.
                        Mainly becuase I guess I had to move out of my comfort zone! Nonetheless, I went on this journey
                        to start using Terraform and learn as I went ahead with it. Needless to say I did end up discovering the pros and the cons
                        of the terraform provisioning environment.</p>
                    <p>Now after spending a few months using Terraform I think its a good time to share my learnings from the experience.</p>
                    <ul>
                        <h5>A Precursor to pros and cons:</h5>
                        <li><b>Do not assume anything!</b></li>
                                If you've used any provisioning tool other than Terraform then make sure you don't assume anything based on the tools you have used, while moving forward with Terraform.
                        <li><b>No major version released yet</b></li>
                                Terraform still hasn't had a major version release, so it may not be as evolved as you'd expect an infrastructure provisioning tool to be.
                    </ul>
                    <ul>
                        <h5>Lets start with the good things.</h5>
                        <li><code>terraform plan</code> gives the ability to see what changes are going to be applied and more importantly how the existing resources would be affected.
                            This is almost like a pre-deployment QA on the live setup. Similar to Cloudformation Change Sets.
                        </li>
                        <li>The <code>create_before_destroy</code> flag can be set for pretty much all resources and terraform honours it even if AWS doesn't provide such an an attribute natively for the resources.</li>
                        <li>Terraform gives the ability to take existing resources created by some other means and bring it under the Terraform plan.</li>
                        <li>Terraform syntax is very easy to use.</li>
                        <li>Terraform supports a large number of providers which makes it easy to use one tools across the board rather than a bunch.</li>
                    </ul>
                    <ul>
                        <h5>Moving on to outliers</h5>
                        <li>Terraform stores the state in a file with the <code>.tfstate</code> extension. Basically if the file gets accidently deleted or the file gets corrupted, the stack state is lost!
                            This can be regenerated by either running the terraform plan again or by import each and every resource. However, it should be noted that
                            <pre><code><i>Each resource in Terraform must implement some basic logic to become importable. As a result, not all Terraform resources are currently importable.<a href="https://www.terraform.io/docs/import/importability.html" target="_blank">Source</a></i></code></pre>
                        </li>
                        <li>State Locking is a big concern with Terraform since the state is stored physically on disk. Each terraform plan need to specify the backend (read state) that it needs to initialize before
                            provisioning or updating managed infrastructure. If two terraform run access the same state file and are triggered at the same time then they'll end up accessing and altering the same state. Potentially corrupting the state file.
                        </li>
                        <li>Specific to autoscaling groups and launch configurations, terraform doesn't associate an updated launch configuration with an existing autoscaling group.</li>
                        <li>If a terraform plan fails mid way through a run then it doesn't rollback to the earlier stable version. Rather the stack might end up in a state of limbo where certain resources that should have been replaced during the run end up getting deleted.</li>
                        <li>Unlike Cloudformation, the resources within a terraform plan are not automatically tagged with the stack id. All tags need to be configured in the terraform module.</li>
                    </ul>
                    <ul>
                        <h5>Workarounds</h5>
                        There are always workarounds, maybe not the most ideal but workable. Some of the workarounds for the outliers above are as below:
                        <li>There is nothing that can be done around state corruption sadly. But state storage can be fixed. Ideally the state file should be kept remote and version controlled.
                            Github may not be the most ideal location. A secured S3 bucket would be a better option.</li>
                        <li>To address state locking, <a href="https://www.terraform.io/docs/state/index.html">terraform website</a> provides a decent solution using S3 and dynamodb.
                            But the configuration of the backend key to be unique still is a manual step.
                            <pre><code>terraform {
    backend "s3" {
        role_arn = "arn:aws:iam::XXXXXXXX:role/terraform-state"
        region = "ap-southeast-1"
        lock_table = "terraform"
        bucket = "bucket-name"
        key = "make-sure-this-is-unique-per-terraform-plan-per-environment"
    }
}

    provider "aws" {
        region = "ap-southeast-1"
        allowed_account_ids = ["XXXXXXXX"]
}</code></pre>
                        </li>
                        <li>In order to fix the autoscaling group and launch configuration syncing issue.
                            The ideal way would be to have the autoscaling group and the launch configuration named the same.
                            <pre><code>resource "aws_launch_configuration" "LC" {
    name_prefix   = "${var.stack_name}-"
    ...
    ...
    ...
}

resource "aws_autoscaling_group" "ASG" {
    name                      = "${aws_launch_configuration.LC.name}"
    launch_configuration      = "${aws_launch_configuration.LC.name}"
    ...
    ...
    ...
}</code></pre>
                        </li>
                        <li>To avoid resources being killed in case of a failed terraform run, make sure the <code>create_before_destroy</code> flag is set to <code>true</code>.
                            However, this flag is only available for most resources, not all.</li>
                    </ul>

                    These are a few learnings from the terraform ecosystem. Enough to get started with atleast!
                </div>
            </div>
        </section>

        <!-- Footer -->
            <footer id="footer">
                <div class="inner"></div>
            </footer>

        <!-- Scripts -->
            <script src="../assets/js/jquery.min.js"></script>
            <script src="../assets/js/skel.min.js"></script>
            <script src="../assets/js/util.js"></script>
            <!--[if lte IE 8]><script src="../assets/js/ie/respond.min.js"></script><![endif]-->
            <script src="../assets/js/main.js"></script>
            <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
                ga('create', 'UA-104593082-1', 'auto');
                ga('send', 'pageview');
            </script>
    </body>
</html>